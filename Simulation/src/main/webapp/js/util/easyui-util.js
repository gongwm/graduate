var ACTION_SUCCESS = 0;var ACTION_FAILED = 1;var LOGIN_REQUIRED = 2;var DB_CONNECTION_TIMEOUT = 3;String.prototype.format = function(var args = arguments;return this.replace(/\{(\d+)\}/g, function(m, i) {return args[i];});}function S(id) {var result = $("#" + id);if (result.length != 1) {throw new ConventionError(id);}return result;}function changeTheme(type) {var themePath = "/HPPumTurReg/js/easyui-1.4.5/themes/{0}/easyui.css";$("#theme").attr("href", themePath.format(type));}function changeToParentTheme() {var theme = _rootWindow().current_theme;if (!_.isNil(theme)) {changeTheme(theme);}}$(function() {changeToParentTheme();});function ConventionError(key) {this.name = "convention error";this.message = "against convention error for key: " + key;}ConventionError.prototype = _.create(Error.prototype, {'constructor' : ConventionError});function makeInput(var inputs = arguments;var result = "?inputStr=";for ( var i in inputs) {var input = inputs[i];if (_.isArray(input)) {input = concat(input, ",");}result += input + "}return result.substring(0, result.length - 2);}function concat(array, separator) {var result = "";for ( var i in array) {result += array[i] + separator;}return result.substring(0, result.length - separator.length);}function formatDate(date) {return date.getFullYear() + "-" + (date.getMonth() + 1) + "-"+ date.getDate();}function forbidImg() {$("img").each(function() {var _this = $(this);_this.on("dragstart", function() {return false;});_this.on("contextmenu", function() {return false;});_this.on("selectstart", function() {return false;});});}function _fixbug() {$(".panel-header").css("height", "16px");$(".panel-header").css("width", "");$(".panel-body").css("width", "");$(".datagrid-cell-group").css("width", "");}function attachTip(id, content) {S(id).tooltip({content : content,showDelay : 1000});}function showMessage(message, duration) {if (duration && duration <= 100) {return;}if ((!message) || (message == "")) {return;}if (!arguments[1]) {duration = 700;}$.messager.show({title : '通知',msg : message,timeout : duration,showType : 'slide'});}function deleteRow(tableSelector, columnName, value) {var table = $(tableSelector);var rows = table.datagrid("getRows");var row;for ( var i in rows) {row = rows[i];if (row[columnName] === value) {break;}}var idx = table.datagrid("getRowIndex", row);table.datagrid("deleteRow", idx);}function selectRow(tableId, idx) {if (hasRows(tableId)) {var count = countRows(tableId);if (idx >= 0 && idx < count) {S(tableId).datagrid("selectRow", idx);}}}function hasRows(tableId) {return countRows(tableId) > 0;}function countRows(tableId) {var rows = S(tableId).datagrid("getRows");if (!rows) {return 0;}return rows.length;}function getRowData(tableId, rowIdx) {var result = null;var count = countRows(tableId);if (rowIdx >= 0 && rowIdx < count) {result = getRows(tableId)[rowIdx];}return result;}function getSelectedRow(tableId) {return S(tableId).datagrid("getSelected");}function getRows(tableId) {return S(tableId).datagrid("getRows");}function makeOperationTable(url, tableId, queryIt, deleteIt) {var success = function(data) {var infos = data.historyInfos;var rows = _convert(infos).rows;for ( var i in rows) {var row = rows[i];var operation = row.operation;var html = '<button class="operation_query" \style="margin-right:10px" value="'+ operation+ '">查询</button><button class="operation_delete" \style="margin-right:10px"'+ ' value="' + operation + '">删除</button>';row.operation = html;}$("#" + tableId).datagrid("loadData", rows);$(".operation_query").each(function() {$(this).click(function() {var operation = $(this).val();queryIt(operation);});});$(".operation_delete").each(function() {$(this).click(function() {var operation = $(this).val();deleteIt(operation);});});};getJSON(url, success);}function setTexts(data, prefix) {if (_.isNil(prefix)) {prefix = "text_";}selector = "input[id^='{0}']".format(prefix);var callback = function(container, value) {container.textbox("setValue", value);}conventionHelper(data, selector, prefix, callback);}function getTexts(prefix) {if (_.isNil(prefix)) {prefix = "text_";}selector = "input[id^='{0}']".format(prefix);var result = {};var callback = function(container, key) {if (container && container.textbox()) {result[key] = container.textbox("getValue");}}conventionHelper(null, selector, prefix, callback);return result;}function conventionHelper(data, selector, prefix, callback) {var containers = $(selector);containers.each(function() {var container = $(this);var id = container.attr("id");if (_.startsWith(id, prefix)) {var trimed = _.replace(id, prefix, "");var key = _.camelCase(trimed);var value = null;if (data != null) {value = data[key];} else {value = key;}if (!_.isUndefined(value) && !_.isNull(value)) {callback(container, value, id);}} else {throw new ConventionError(id);}});}function fillCombobox(data, prefix) {if (_.isNil(prefix)) {prefix = "combobox_";}selector = "select[id^='{0}']".format(prefix);var callback = function(container, value) {container.combobox({valueField : "value",textField : "text",data : value,editable : false,});container.combobox("select", "-1");}conventionHelper(data, selector, prefix, callback);}function setText(id, value) {var text = $("#" + id);if (_.isNil(value)) {return function(value) {text.textbox("setValue", value);}}text.textbox("setValue", value);}function getText(id) {return $("#" + id).textbox("getValue");}function setDate(id, date) {$("#" + id).datebox("setValue", date);}function getDate(id) {return $("#" + id).datebox("getValue");}function getTodayDate() {return formatDate(new Date());}function getLastTodayDate() {var lastTodayMillis = new Date().getTime() - 7 * 24 * 60 * 60 * 1000;var lastToday = new Date();lastToday.setTime(lastTodayMillis);return formatDate(lastToday);}function getComboboxValue(id) {return $("#" + id).combobox("getValue");}function setComboboxValue(id, value) {$("#" + id).combobox("setValue", value);}function getSpinnerValue(id) {return S(id).spinner("getValue");}function enableButton(selector) {if (_.isNil(selector)) {selector = ".easyui-linkbutton";}$(selector).each(function() {$(this).linkbutton("enable");});}function disableButton(selector) {if (_.isNil(selector)) {selector = ".easyui-linkbutton";}$(selector).each(function() {$(this).linkbutton("disable");});}function buttonDisabled(id) {return S(id).linkbutton("options").disabled;}function clearText(var selector = ".easyui-textbox";if (arguments.length == 1) {var first = arguments[0];if (_.isString(first)) {selector = first;} else if (_.isArray(first)) {var ids = first;for ( var idx in ids) {S(ids[idx]).textbox("setValue", "");}return;}} else if (arguments.length == 2) {selector = "{0}[id^={1}]".format(arguments[0], arguments[1]);}$(selector).each(function() {$(this).textbox("setValue", "");});}function closeCurrentTab(selector) {if (_.isNil(selector)) {selector = "#tabs";}var tabs = $(selector);var selected = tabs.tabs("getSelected");var idx = tabs.tabs("getTabIndex", selected);if (idx != 0) {tabs.tabs("close", idx);}}function output(data) {var outputStr = data.outputStr;if (_.isString(outputStr)) {return outputStr.split("}return null;}function _resultCode(data) {var out = output(data);if (!_.isNil(out)) {return parseInt(out[0]);}return ACTION_SUCCESS;}function _message(data) {var message = null;var out = output(data);if (!_.isNil(out)) {message = out[1];}return message;}function _isError(data, errorCode) {var code = _resultCode(data);if (code == errorCode) {return true;}return false;}function hasActionError(data) {return _isError(data, ACTION_FAILED);}function hasLoginError(data) {return _isError(data, LOGIN_REQUIRED);}function hasDBConnectionError(data) {return _isError(data, DB_CONNECTION_TIMEOUT);}function hasNoError(data) {return _isError(data, ACTION_SUCCESS);}function handleError(data, callback, hide) {if (_.isNil(hide)) {hide = true;}var message = _message(data);if (!callback) {callback = {};}if (_.isFunction(callback)) {var success = callback;callback = {};callback.success = success;} else if (_.isObject(callback)) {if (!(callback.relogin)) {callback.relogin = function(data) {if (message) {_rootWindow().location.href = _message(data);}};}}if (!(callback.success)) {callback.success = function(data) {};}if (!(callback.fail)) {callback.fail = function(data) {};}var duration = 3000;if (hasNoError(data)) {duration = 700;callback.success(data);} else if (hasLoginError(data)) {duration = 0;callback.relogin(data);} else if (hasActionError(data)) {callback.fail(data);} else if (hasDBConnectionError(data)) {hideMask();}expandAccordion();_fixbug();if (hide) {hideMask();}showMessage(message, duration);}function getJSON(url, callback, checkConn) {if (_.isUndefined(checkConn)) {checkConn = true;}var success = function() {$.getJSON(url, function(data) {handleError(data, callback);});}if (checkConn) {var timeout = true;var testUrl = "/HPPumTurReg/test-connection";var testConn = $.getJSON(testUrl, function(data) {timeout = false;handleError(data, success, false);});setTimeout(function() {if (timeout) {testConn.abort();hideMask();showMessage("网络连接异常，请检查网络连接！");}}, 8000);} else {success();}}function post(url, data, callback) {$.post(url, data, function(data) {handleError(data, callback);});}function _rootWindow() {var result = null;var w = window;while (!(w.parent === w)) {w = w.parent;}return w;}function expandAccordion(selector) {if (!selector) {selector = ".easyui-accordion";}var accordion = $(selector);if (accordion) {accordion.each(function(i) {var count = $(this).accordion("panels").length;for (var c = 0; c < count; c = c + 1) {$(this).accordion("getPanel", c).panel("expand");}});}}function collapseAccordion(selector) {if (!selector) {selector = ".easyui-accordion";}var accordion = $(selector);if (accordion) {accordion.each(function(i) {var count = $(this).accordion("panels").length;for (var c = 0; c < count; c = c + 1) {$(this).accordion("getPanel", c).panel("collapse");}});}}function expandAccordionWithIdx(idx, selector) {if (!selector) {selector = ".easyui-accordion";}if ($(selector).length > 1) {throw new Error("too many accordion");}$(selector).accordion("getPanel", idx).panel("expand");}function collapseAccordionWithIdx(idx, selector) {if (!selector) {selector = ".easyui-accordion";}if ($(selector).length > 1) {throw new Error("too many accordion");}$(selector).accordion("getPanel", idx).panel("collapse");}function _convert(data) {var result = {};result['rows'] = []var rows = data.rows;for ( var i in rows) {result['rows'].push(rows[i]['row']['row']);}return result;}function arrangeLocation(win) {var w = $(window).width();var h = $(window).height();var options = win.window("options");var mwidth = options.width, mheight = options.height;var top = (h - mheight) / 2;top = top < 0 ? 10 : top;var left = (w - mwidth) / 2;win.window("move", {top : top,left : left});}function loadData(id, data) {$('#' + id).datagrid('loadData', _convert(data));}var mask_id = "_mask";var mask_id_selector = "#" + mask_id;var mask_open = false;$(function() {if (!$(mask_id_selector)) {throw new Error("name collapse! change a new mask_id");}var html = '<div id="'+ mask_id+ '" style="width: 300px; height: 150px; padding: 10px; background-color: #EBEBEB;">\<table style="margin-left: 45px; margin-top: 30px">\<tr><td><img alt="waiting..." src="/HPPumTurReg/images/waiting.gif" \style="width: 48px; height: 48px;" /></td><td><div>处理中，请稍候...</div>\</td></tr></table></div>'$("body").append(html);$(mask_id_selector).window({title : "",modal : true,closed : true,closable : false,draggable : false,collapsible : false,minimizable : false,maximizable : false});$(".window-shadow").remove();});function showMask() {if (!mask_open) {$(mask_id_selector).window("open");$(mask_id_selector).window("center");mask_open = true;}}function hideMask() {if (mask_open) {$(mask_id_selector).window("close");mask_open = false;}}var previewer_div = "_previewerDiv";var previewer_div_selector = "#" + previewer_div;var previewer_id = "_previewer";var previewer_name = "_previewer";var previewer_selector = "#" + previewer_id;$(function() {if (!$(previewer_id)) {throw new Error("name collapse! change a new previewer_id");}var html = '<div id="{0}" class="easyui-window" title="打印预览" \style="width: 800px; height: 450px; padding: 10px; overflow: hidden">\<iframe id="{1}" name="{2}"	style="width: 100%; height: 100%; \border: none"></iframe></div>'.format(previewer_div, previewer_id, previewer_name);$("body").append(html);$(previewer_div_selector).window({modal : true,closed : true});});function previewPage(url, postData) {showMask();$.post(url, postData, function(data) {if (_.isNil(data)) {showMessage("生成报告失败，请重试！", 2000);} else {window.frames[previewer_name].location.href = data.htmlPath;var win = $(previewer_div_selector);win.window('open');arrangeLocation(win);}hideMask();});}function showWindow(title, hiddenId, size) {var win = $(previewer_div_selector);var options = win.window("options");options.title = title;options.content = S(hiddenId).clone().show();if (!_.isNil(size)) {options.width = size.width || 800;options.height = size.height || 450;}win.window(options);win.window("open");arrangeLocation(win);}function showWindowContent(title, content) {var win = $(previewer_div_selector);var options = win.window("options");options.title = title;options.content = content;win.window(options);win.window("open");arrangeLocation(win);}function hideWindow() {$(previewer_div_selector).window("close");}function exportPdfFile(url, postData) {showMask();$.post(url, postData, function(data) {handleError(data, function(data) {var path = data.pdfPath;var down = "/HPPumTurReg/util/download-file?filePath=" + path;window.open(down);hideMask();});});}function fullScreen() {elem = document.documentElement;if (elem.webkitRequestFullScreen) {document.documentElement.webkitRequestFullScreen();} else if (elem.mozRequestFullScreen) {elem.mozRequestFullScreen();} else if (elem.requestFullScreen) {elem.requestFullscreen();} else {}}function exitFullscreen() {var elem = document;if (elem.webkitCancelFullScreen) {document.webkitCancelFullScreen();} else if (elem.mozCancelFullScreen) {elem.mozCancelFullScreen();} else if (elem.cancelFullScreen) {elem.cancelFullScreen();} else if (elem.exitFullscreen) {elem.exitFullscreen();} else {}}